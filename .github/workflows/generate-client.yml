name: Generate Unity C# Client from Swagger

on:
  repository_dispatch:
    types: [swagger_updated]

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenAPI Generator CLI
        run: npm install -g @openapitools/openapi-generator-cli

      - name: Download Swagger JSON
        run: |
          SWAGGER_URL="${{ github.event.client_payload.swagger_url }}"
          mkdir -p Temp
          curl -L -o Temp/swagger.json "$SWAGGER_URL"
          echo "Downloaded Swagger JSON:"
          ls -lh Temp/swagger.json

      - name: Generate DTO classes
        run: |
          DTO_OUTPUT_DIR="Assets/Matuyuhi/LudiscanApiClient/Runtime/ApiClient/Dto"
          TEMP_DIR="Temp/Api"

          mkdir -p "$DTO_OUTPUT_DIR"

          openapi-generator-cli generate \
            -i Temp/swagger.json \
            -g csharp \
            -o "$TEMP_DIR" \
            -c api-generate-config.json \
            --global-property models,modelDocs=false,modelTests=false

          echo "Copying and fixing generated models..."
          FOUND_DIR=$(find "$TEMP_DIR" -type d -name "Model" | head -1)

          if [ -n "$FOUND_DIR" ] && [ -d "$FOUND_DIR" ]; then
            echo "Found model directory: $FOUND_DIR"
            for f in "$FOUND_DIR"/*.cs; do
              if [ -f "$f" ]; then
                filename=$(basename "$f")
                echo "  Processing: $filename"
                # Linux sed (no empty string after -i)
                sed -i \
                  -e '/using FileParameter/d' \
                  -e '/using OpenAPIDateConverter/d' \
                  -e 's/namespace LudiscanApiClient\.Runtime\.ApiClient\.Dto\.Model/namespace LudiscanApiClient.Runtime.ApiClient.Dto/' \
                  "$f"
                cp -f "$f" "$DTO_OUTPUT_DIR/"
              fi
            done
            echo "DTO classes generated successfully in $DTO_OUTPUT_DIR"
          else
            echo "Warning: Generated model directory not found"
            echo "Searching for .cs files..."
            find "$TEMP_DIR" -name "*.cs" 2>/dev/null | head -20
          fi

      - name: Clean temporary files
        run: rm -rf Temp/

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update DTO classes from Swagger v${{ github.event.client_payload.version }}"
          title: "Update DTO classes from Swagger v${{ github.event.client_payload.version }}"
          body: |
            This PR was automatically generated by the `generate-client` workflow.

            ## Changes
            - Updated DTO classes from Swagger specification
            - Swagger version: ${{ github.event.client_payload.version }}
            - Swagger URL: ${{ github.event.client_payload.swagger_url }}

            ## Notes
            - DTO classes are generated using OpenAPI Generator
            - The API client uses UnityWebRequest (not RestSharp)
          branch: "swagger-update/v${{ github.event.client_payload.version }}"
          base: main
          labels: |
            automated
            swagger-update
